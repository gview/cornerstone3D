# MPR布局智能切换功能

## 功能概述

本文档描述MPR查看器中的双向智能切换功能：
1. **从单序列MPR切换到双序列MPR**：保留当前volume作为第一个序列，加载新的序列作为第二个序列
2. **从双序列MPR切换到标准MPR**：智能地保留当前激活视口所属的序列，隐藏另一个序列

---

## 功能1：单序列MPR → 双序列MPR

### 功能描述

当用户从单序列MPR布局（1行3列，共3个视口）切换到双序列MPR布局（2行3列，共6个视口）时，系统会智能地保留当前显示的序列作为第一个序列，并自动加载第二个序列。

### 实现原理

#### 1. 保留当前序列
- 当前显示的volume（`volumeId`）自动成为双序列布局的**序列1**（第一行3个视口）
- 保留当前序列的所有状态（窗宽窗位、相机位置、切片索引等）

#### 2. 加载第二个序列
- 从已加载的序列列表中查找第二个序列（不是当前序列的序列）
- 自动创建并缓存第二个序列的volume（`secondaryVolumeId`）
- 如果第二个序列的volume已存在，直接使用缓存的实例

#### 3. 布局切换
- 使用 `dynamicViewportManager` 动态创建6个视口
- 前3个视口（索引0-2）显示序列1
- 后3个视口（索引3-5）显示序列2

#### 4. 工具组配置
- 创建两个独立的工具组：`mpr-seq1` 和 `mpr-seq2`
- 每个序列的视口使用独立的工具组
- 支持在两个序列之间独立操作（测量、窗宽窗位调整等）

### 代码位置

**文件**：`src/MPRViewer.tsx`
**函数**：`handleLayoutChange`
**代码行**：1952-2015

### 关键日志

```
🔄 切换到双序列 MPR 布局
📋 当前序列将作为序列1保留: series-instance-uid-1
📋 将加载序列2: series-instance-uid-2
✅ 已创建并加载序列2的volume: volume-series-instance-uid-2
🔧 双序列配置 - 序列1: volume-series-1, 序列2: volume-series-2
✅ 双序列 MPR 布局已应用，共 6 个视口
```

### 使用场景

#### 场景1：对比两个不同协议的序列
1. 用户加载了多个序列（如BONE、STD、LUNG等）
2. 当前显示的是BONE序列的单序列MPR
3. 用户切换到双序列MPR布局
4. **结果**：
   - 第一行显示BONE序列（序列1）
   - 第二行显示STD序列（序列2）
   - 可以对比两个不同协议的影像

#### 场景2：对比不同时期的序列
1. 用户加载了同一患者的不同时期检查
2. 当前显示的是近期检查的单序列MPR
3. 用户切换到双序列MPR布局
4. **结果**：
   - 第一行显示近期检查（序列1）
   - 第二行显示历史检查（序列2）
   - 可以对比病情进展

---

## 功能2：双序列MPR → 标准MPR

### 功能描述

当用户从双序列MPR布局（2行3列，共6个视口）切换到标准MPR布局（1行3列，共3个视口）时，系统会智能地保留当前激活视口所属的序列，隐藏另一个序列。

### 实现原理

#### 1. 识别激活序列
- 通过 `activeViewportId` 确定用户点击激活的视口
- 视口索引 0-2 属于序列1（第一行）
- 视口索引 3-5 属于序列2（第二行）

#### 2. Volume 切换
- **激活视口在序列1**：继续使用 `volumeId`，清除 `secondaryVolumeId`
- **激活视口在序列2**：
  - 将 `secondaryVolumeId` 提升为主 `volumeId`
  - 从缓存获取或创建 volume
  - 更新 `volume` 状态
  - 清除 `secondaryVolumeId`

#### 3. 布局切换
- 直接切换到 `grid-1x3` 布局
- 使用静态视口 ID：`['AXIAL', 'SAGITTAL', 'CORONAL']`
- React 自动卸载双序列组件，加载标准MPR组件（`AxialViewport`、`SagittalViewport`、`CoronalViewport`）

#### 4. 工具组清理
- 销毁双序列工具组（`mpr-seq1`、`mpr-seq2`）
- 标准MPR组件会自动使用 `mpr` 工具组

### 代码位置

**文件**：`src/MPRViewer.tsx`
**函数**：`handleLayoutChange`
**代码行**：2218-2367

### 关键日志

```
🔄 从双序列 MPR 切换到标准 MPR 布局
  当前激活视口: viewport-xxx-4
  激活视口属于序列 2
  保留序列: 5 - STD 5mm
  隐藏序列: 3 - BONE 5mm
  使用 volume ID: volume-series-instance-uid
🔧 切换到标准 MPR 布局（使用静态组件）
🔧 清理双序列工具组...
  ✓ 已销毁工具组: mpr-seq1
  ✓ 已销毁工具组: mpr-seq2
✅ 双序列 MPR → 标准 MPR 切换完成
✅ 保留了序列 2 的 MPR 视图
✅ 现在可以正常浏览序列的切片了
```

## 使用场景

### 场景1：保留序列2
1. 用户在双序列MPR布局中点击序列2的任意视口
2. 切换到标准MPR布局
3. 结果：显示序列2的三个MPR视图（Axial、Sagittal、Coronal）
4. 可以正常滚动浏览序列2的所有切片

### 场景2：保留序列1
1. 用户在双序列MPR布局中点击序列1的任意视口
2. 切换到标准MPR布局
3. 结果：显示序列1的三个MPR视图
4. 可以正常滚动浏览序列1的所有切片

## 技术细节

### 为什么使用静态组件？
- 静态组件（`AxialViewport`、`SagittalViewport`、`CoronalViewport`）已经完全实现
- 支持完整的切片浏览、十字线联动、测量等功能
- 避免了动态视口管理器与静态视口ID的不匹配问题

### Volume 缓存机制
- 使用 `volumeLoader.createAndCacheVolume()` 创建 volume
- 后续切换时使用 `volumeLoader.getVolume()` 从缓存获取
- 避免重复加载，提高性能

### 状态同步
- 更新 `volumeId`、`volume`、`currentSeriesUID` 状态
- 清除 `secondaryVolumeId` 状态
- 标准MPR组件会自动使用新的 volume

## 使用场景

### 功能1使用场景

#### 场景1：对比两个不同协议的序列
1. 用户加载了多个序列（如BONE、STD、LUNG等）
2. 当前显示的是BONE序列的单序列MPR
3. 用户切换到双序列MPR布局
4. **结果**：
   - 第一行显示BONE序列（序列1）
   - 第二行显示STD序列（序列2）
   - 可以对比两个不同协议的影像

#### 场景2：对比不同时期的序列
1. 用户加载了同一患者的不同时期检查
2. 当前显示的是近期检查的单序列MPR
3. 用户切换到双序列MPR布局
4. **结果**：
   - 第一行显示近期检查（序列1）
   - 第二行显示历史检查（序列2）
   - 可以对比病情进展

### 功能2使用场景

#### 场景1：保留序列2
1. 用户在双序列MPR布局中点击序列2的任意视口
2. 切换到标准MPR布局
3. 结果：显示序列2的三个MPR视图（Axial、Sagittal、Coronal）
4. 可以正常滚动浏览序列2的所有切片

#### 场景2：保留序列1
1. 用户在双序列MPR布局中点击序列1的任意视口
2. 切换到标准MPR布局
3. 结果：显示序列1的三个MPR视图
4. 可以正常滚动浏览序列1的所有切片

---

## 技术细节

### 为什么使用静态组件？
- 静态组件（`AxialViewport`、`SagittalViewport`、`CoronalViewport`）已经完全实现
- 支持完整的切片浏览、十字线联动、测量等功能
- 避免了动态视口管理器与静态视口ID的不匹配问题

### Volume 缓存机制
- 使用 `volumeLoader.createAndCacheVolume()` 创建 volume
- 后续切换时使用 `volumeLoader.getVolume()` 从缓存获取
- 避免重复加载，提高性能

### 状态同步
- 更新 `volumeId`、`volume`、`currentSeriesUID` 状态
- 清除或设置 `secondaryVolumeId` 状态
- 标准MPR组件会自动使用新的 volume

---

## 测试要点

### 功能1测试（单序列 → 双序列）
1. **序列保留**：验证当前序列成为序列1（第一行）
2. **第二序列加载**：验证第二个序列正确加载并显示在序列2（第二行）
3. **序列对比**：验证可以同时查看和对比两个序列
4. **独立操作**：验证两个序列可以独立进行测量、窗宽窗位调整等操作

### 功能2测试（双序列 → 标准MPR）
1. **切换到序列1**：在序列1视口激活时切换，验证显示序列1
2. **切换到序列2**：在序列2视口激活时切换，验证显示序列2
3. **切片浏览**：验证可以正常滚动浏览所有切片
4. **十字线联动**：验证三个方向的十字线联动正常
5. **测量工具**：验证测量工具正常工作
6. **切换回双序列**：验证可以再次切换到双序列MPR布局

---

## 已知限制

- 其他协议布局暂时也映射到标准MPR布局
- 切换后会清除双序列的位置同步器
- 需要至少加载2个序列才能切换到双序列MPR布局

---

## 未来改进方向

1. ✅ **支持从标准MPR切换到双序列MPR**（已完成）
2. 保存双序列布局时的视图状态（相机位置、当前切片等）
3. 支持更多协议布局的双序列版本
4. 支持在双序列布局下手动选择要显示的两个序列（不自动选择第二个序列）
