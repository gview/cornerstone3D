# 布局面板调试指南

## 问题：点击协议布局按钮没有响应

### 已添加的调试功能

我已经在所有的布局按钮上添加了调试日志，现在当您点击任何布局按钮时，控制台会显示相应的日志。

### 测试步骤

1. **打开浏览器控制台**（F12）

2. **点击布局按钮**（▦ 图标）打开布局面板

3. **测试网格布局**
   - 切换到"网格布局"标签
   - 点击任意网格布局按钮（如 "1×1 单视图"）
   - **预期控制台输出**：
     ```
     🔘 网格布局按钮被点击: grid-1x1
     🔄 布局切换请求: grid-1x1
     ✅ 布局已切换到: grid-1x1，视口已重新计算大小并重置相机
     ```

4. **测试协议布局**
   - 切换到"协议布局"标签
   - 点击任意协议布局按钮（如 "MPR 三视图"）
   - **预期控制台输出**：
     ```
     🔘 协议布局按钮被点击: mpr
     🔄 布局切换请求: mpr
     🔄 协议布局 "mpr" 暂时映射到标准 MPR 布局
     ℹ️ "MPR 三视图" 协议布局暂时使用标准三视图显示
     ✅ 布局已切换到: mpr，视口已重新计算大小并重置相机
     ```

5. **测试双序列 MPR 布局**
   - 在"协议布局"标签中
   - 点击 "🔷🔷 双序列 MPR"
   - **预期控制台输出**：
     ```
     🔘 协议布局按钮被点击: dual-mpr
     🔄 布局切换请求: dual-mpr
     🔄 切换到双序列 MPR 布局
     ```
   - **如果序列少于 2 个**：
     ```
     ⚠️ 双序列 MPR 布局需要至少加载 2 个序列。当前只有 1 个序列。
     ```

### 问题排查

#### 情况 1: 没有任何日志输出

**可能原因**：
- 布局面板没有正确打开
- 按钮被其他元素遮挡
- JavaScript 错误导致事件处理失败

**解决方法**：
1. 确认布局面板确实打开了（应该看到一个弹出窗口）
2. 检查控制台是否有红色错误信息
3. 尝试刷新页面重试

#### 情况 2: 只有 "🔘 按钮被点击" 日志，但没有后续日志

**可能原因**：
- `onLayoutSelect` 回调没有正确传递
- `handleLayoutChange` 函数没有执行

**解决方法**：
1. 检查数据是否已加载（需要加载 DICOM 文件）
2. 查看 `renderingEngine` 和 `volume` 是否已初始化
3. 检查控制台是否有警告信息

#### 情况 3: 日志显示 "无法切换布局: 渲染引擎或体积数据未初始化"

**可能原因**：
- DICOM 文件未加载
- 初始化未完成

**解决方法**：
1. 确保已加载 DICOM 文件
2. 等待初始化完成（应该看到图像显示）
3. 刷新页面重试

#### 情况 4: 双序列 MPR 提示需要 2 个序列

**这是正常行为**：
- 双序列 MPR 布局需要至少 2 个序列
- 如果只有 1 个序列，会显示这个提示
- 需要加载包含多个序列的 DICOM 数据

### 调试命令

在浏览器控制台中执行以下命令检查状态：

```javascript
// 检查当前布局
console.log('当前布局:', document.querySelector('.layout-panel') ? '面板已打开' : '面板未打开')

// 检查按钮是否存在
console.log('协议布局按钮数量:', document.querySelectorAll('.protocol-layout-item').length)
console.log('网格布局按钮数量:', document.querySelectorAll('.grid-layout-item').length)

// 检查是否有错误
console.log('是否有未捕获的错误:', window.onerror)
```

### 预期行为对比

| 操作 | 网格布局 | 协议布局（非双序列） | 双序列 MPR |
|------|---------|-------------------|-----------|
| 点击按钮 | ✅ 应有日志 | ✅ 应有日志 | ✅ 应有日志 |
| 视觉变化 | ✅ 布局改变 | ⚠️ 暂时映射到三视图 | ✅ 6 视口（需2序列） |
| 后续日志 | ✅ 切换完成 | ✅ 映射提示 | ✅ 或序列不足提示 |

### 文件修改

已修改的文件：
1. **[EnhancedLayoutPanel.tsx](src/components/panels/EnhancedLayoutPanel.tsx)**
   - 添加 `handleLayoutClick` 函数到网格布局选择器
   - 添加 `handleLayoutClick` 函数到协议布局选择器
   - 所有按钮点击都会输出调试日志

2. **[MPRViewer.tsx](src/MPRViewer.tsx)**
   - 添加协议布局映射提示日志
   - 改进了双序列 MPR 布局的日志

### 下一步

请按照测试步骤操作，并告诉我在控制台中看到了什么日志。这样我可以进一步帮助您诊断问题。

---

**版本**: 1.0
**最后更新**: 2026-01-24
