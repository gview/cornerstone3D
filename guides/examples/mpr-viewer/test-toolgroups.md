# MPR Viewer ToolGroup 测试指南

## 测试前准备

1. 启动开发服务器:
```bash
cd guides/examples/mpr-viewer
npm install
npm run dev
```

2. 打开浏览器访问 `http://localhost:5173`

3. 打开浏览器控制台 (F12)

## 测试场景

### 测试 1: 单视口模式 (grid-1x1)

**步骤**:
1. 点击 "加载 DICOM 文件"
2. 选择 DICOM 文件并加载
3. 等待体积数据加载完成
4. 在布局面板中选择 "1×1" 布局

**验证点**:
- ✅ 工具面板的下拉菜单中**没有**十字线工具选项
- ✅ 可以使用窗宽窗位工具 (左键拖动)
- ✅ 可以使用平移工具 (中键拖动)
- ✅ 可以使用缩放工具 (右键拖动)
- ✅ 可以使用滚轮换层 (滚轮)
- ✅ 鼠标在视口上移动时,控制台**没有**以下错误:
  ```
  CrosshairsTool.mouseMoveCallback - Cannot read properties of undefined (reading 'length')
  ```
- ✅ 控制台显示: `✅ 布局切换完成: grid-1x1, 新视口数量: 1, ToolGroup: default`

**预期结果**: 完全没有 CrosshairsTool 相关的错误

---

### 测试 2: 双视口模式 (grid-1x2)

**步骤**:
1. 从任何布局切换到 "1×2" 布局

**验证点**:
- ✅ 工具面板的下拉菜单中**有**十字线工具选项 (🎯 十字线)
- ✅ 点击十字线工具后,工具图标变为 🎯
- ✅ 在任一视口中点击,两个视口都显示十字线
- ✅ 移动鼠标时,十字线在两个视口之间同步
- ✅ 控制台显示: `✅ 布局切换完成: grid-1x2, 新视口数量: 2, ToolGroup: mpr`

**预期结果**: Crosshairs 正常工作,视口之间同步

---

### 测试 3: MPR 三视图模式 (mpr)

**步骤**:
1. 切换到 "MPR 协议" 布局

**验证点**:
- ✅ 显示三个视口 (Axial, Sagittal, Coronal)
- ✅ 工具面板显示十字线工具
- ✅ 在任一视口中点击,三个视口都显示十字线
- ✅ 移动鼠标时,十字线在三个视口之间同步
- ✅ 控制台显示: `✅ 布局切换完成: mpr, 新视口数量: 3, ToolGroup: mpr`

**预期结果**: MPR 三视图十字线完美同步

---

### 测试 4: 四视口模式 (grid-2x2)

**步骤**:
1. 切换到 "2×2" 布局

**验证点**:
- ✅ 显示 2×2 = 4 个视口
- ✅ 工具面板显示十字线工具
- ✅ 十字线在四个视口之间同步
- ✅ 控制台显示: `✅ 布局切换完成: grid-2x2, 新视口数量: 4, ToolGroup: mpr`

**预期结果**: 四视口十字线同步正常

---

### 测试 5: 九视口模式 (grid-3x3)

**步骤**:
1. 切换到 "3×3" 布局

**验证点**:
- ✅ 显示 3×3 = 9 个视口
- ✅ 工具面板显示十字线工具
- ✅ 十字线在九个视口之间同步
- ✅ 控制台显示: `✅ 布局切换完成: grid-3x3, 新视口数量: 9, ToolGroup: mpr`

**预期结果**: 九视口十字线同步正常 (性能测试)

---

### 测试 6: 布局切换 - 多视口到单视口

**步骤**:
1. 从 MPR (3视口) 或任何多视口布局
2. 切换到 "1×1" 布局

**验证点**:
- ✅ 控制台显示: `🔄 布局切换: 3 → 1 视口`
- ✅ 控制台显示: `🔄 切换 ToolGroup: 使用 'default' 工具组`
- ✅ 控制台显示: `🧹 清理旧视口从 ToolGroup...`
- ✅ 如果当前工具是十字线,显示: `⚠️ 切换到单视口模式,从十字线工具切换到窗宽窗位工具`
- ✅ 控制台显示: `✅ 布局切换完成: grid-1x1, 新视口数量: 1, ToolGroup: default`
- ✅ 工具面板的下拉菜单中**没有**十字线工具选项
- ✅ 鼠标移动不产生 CrosshairsTool 错误

**预期结果**: 平滑切换,无错误,工具正确更新

---

### 测试 7: 布局切换 - 单视口到多视口

**步骤**:
1. 从 "1×1" 布局
2. 切换到 "2×2" 布局

**验证点**:
- ✅ 控制台显示: `🔄 布局切换: 1 → 4 视口`
- ✅ 控制台显示: `🔄 切换 ToolGroup: 使用 'mpr' 工具组`
- ✅ 控制台显示: `🧹 清理旧视口从 ToolGroup...`
- ✅ 控制台显示: `✅ 布局切换完成: grid-2x2, 新视口数量: 4, ToolGroup: mpr`
- ✅ 工具面板的下拉菜单中**有**十字线工具选项
- ✅ 十字线功能正常

**预期结果**: 平滑切换,无错误,Crosshairs 自动可用

---

### 测试 8: 快速连续切换布局

**步骤**:
1. 快速点击以下布局顺序:
   - 1×1 → 2×2 → 3×3 → 1×2 → MPR → 1×1

**验证点**:
- ✅ 每次切换都成功完成
- ✅ 控制台无错误
- ✅ 视口正确显示
- ✅ 工具状态正确更新

**预期结果**: 快速切换无崩溃,无内存泄漏

---

### 测试 9: 测量工具切换

**步骤**:
1. 在任何布局下
2. 从工具面板切换不同的测量工具:
   - 窗宽窗位 → 长度测量 → 角度测量 → 窗宽窗位

**验证点**:
- ✅ 工具切换流畅
- ✅ 每个工具都能正常工作
- ✅ 控制台显示正确的工具激活信息

**预期结果**: 所有工具都能正常切换和使用

---

### 测试 10: 边缘情况

**测试 10a: 在单视口模式尝试激活十字线**

**步骤**:
1. 切换到 "1×1" 布局
2. 尝试通过代码或控制台调用 `handleToolChange('Crosshairs')`

**验证点**:
- ✅ 控制台显示: `⚠️ 单视口模式下不支持十字线工具，自动切换到窗宽窗位工具`
- ✅ 工具不会切换到十字线
- ✅ 无错误产生

**测试 10b: 在多视口模式禁用十字线开关**

**步骤**:
1. 切换到多视口布局 (如 2×2)
2. 在工具面板中禁用 "显示十字线" 开关

**验证点**:
- ✅ 十字线消失
- ✅ 工具切换到窗宽窗位
- ✅ 控制台显示: `✅ 已禁用十字线`

**测试 10c: 在单视口模式尝试启用十字线开关**

**步骤**:
1. 切换到 "1×1" 布局
2. 尝试启用 "显示十字线" 开关

**验证点**:
- ✅ 控制台显示: `⚠️ 单视口模式下不支持十字线工具`
- ✅ 开关保持关闭状态
- ✅ 无错误产生

---

## 控制台日志检查清单

在所有测试过程中,控制台**不应该**出现以下错误:

### ❌ 不应该看到的错误:

1. **CrosshairsTool 错误**:
   ```
   CrosshairsTool.js:294 Uncaught TypeError: Cannot read properties of undefined (reading 'length')
   ```

2. **ToolGroup 错误**:
   ```
   ❌ 无法获取工具组
   ```

3. **视口错误**:
   ```
   Cannot read properties of undefined (reading 'center')
   ```

### ✅ 应该看到的日志:

1. **布局切换成功**:
   ```
   🔄 布局切换: 1 → 3 视口
   🔄 切换 ToolGroup: 使用 'mpr' 工具组
   🧹 清理旧视口从 ToolGroup...
   ✅ 布局切换完成: mpr, 新视口数量: 3, ToolGroup: mpr
   ```

2. **工具切换成功**:
   ```
   ✅ 已激活工具: WindowLevel
   ```

3. **工具组创建**:
   ```
   ✅ 创建 default 工具组 (单视口模式)
   ✅ 创建 mpr 工具组 (多视口MPR模式)
   ```

---

## 测试结果记录

| 测试 | 结果 | 备注 |
|------|------|------|
| 测试 1: 单视口模式 | ⬜ 通过 / ❌ 失败 | |
| 测试 2: 双视口模式 | ⬜ 通过 / ❌ 失败 | |
| 测试 3: MPR 三视图 | ⬜ 通过 / ❌ 失败 | |
| 测试 4: 四视口模式 | ⬜ 通过 / ❌ 失败 | |
| 测试 5: 九视口模式 | ⬜ 通过 / ❌ 失败 | |
| 测试 6: 多→单切换 | ⬜ 通过 / ❌ 失败 | |
| 测试 7: 单→多切换 | ⬜ 通过 / ❌ 失败 | |
| 测试 8: 快速切换 | ⬜ 通过 / ❌ 失败 | |
| 测试 9: 工具切换 | ⬜ 通过 / ❌ 失败 | |
| 测试 10: 边缘情况 | ⬜ 通过 / ❌ 失败 | |

---

## 已知问题

如果测试失败,请检查:

1. **浏览器控制台**:
   - 查看是否有其他错误
   - 截图错误信息

2. **网络请求**:
   - DICOM 文件是否正确加载
   - 是否有 404 错误

3. **性能**:
   - 浏览器是否卡顿
   - CPU/内存使用情况

4. **浏览器兼容性**:
   - 推荐使用 Chrome/Edge 最新版本
   - Firefox 可能性能较差

---

## 回归测试

每次修改代码后,建议运行:

1. **基础功能测试**: 测试 1-5
2. **切换测试**: 测试 6-8
3. **边缘测试**: 测试 10

确保修改没有引入新的 bug。

---

## 性能监控

在测试过程中,关注以下性能指标:

- 布局切换时间: < 500ms
- 工具切换时间: < 100ms
- 十字线同步延迟: < 50ms
- 内存使用: 稳定,无持续增长

如果性能不佳,请记录:
- 具体操作
- 视口数量
- 浏览器和版本
- CPU/内存使用情况
