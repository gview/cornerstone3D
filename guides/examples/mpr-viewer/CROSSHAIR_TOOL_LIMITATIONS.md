# åå­—çº¿å·¥å…·ä½¿ç”¨é™åˆ¶ä¸è§„èŒƒ

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† MPR Viewer ä¸­åå­—çº¿å·¥å…·çš„ä½¿ç”¨é™åˆ¶ã€è‡ªåŠ¨ç¦ç”¨é€»è¾‘å’Œæœ€ä½³å®è·µã€‚

---

## åŠŸèƒ½æ¦‚è¿°

åå­—çº¿å·¥å…·ï¼ˆCrosshairs Toolï¼‰æ˜¯ Cornerstone3D ä¸­ç”¨äºå¤šå¹³é¢é‡å»ºï¼ˆMPRï¼‰è§†å›¾åŒæ­¥çš„é‡è¦å·¥å…·ã€‚å®ƒåœ¨å¤šä¸ªè§†å£ä¹‹é—´æ˜¾ç¤ºåå­—äº¤å‰çº¿ï¼Œå¸®åŠ©ç”¨æˆ·åœ¨ä¸åŒå¹³é¢ä¹‹é—´å®šä½ç›¸åŒçš„è§£å‰–ä½ç½®ã€‚

**å·¥å…·å›¾æ ‡**: ğŸ¯
**å·¥å…·ç»„**: MPR å·¥å…·ç»„

---

## ä½¿ç”¨é™åˆ¶

### 1. æœ€å°è§†å£æ•°é‡è¦æ±‚

**åå­—çº¿å·¥å…·éœ€è¦è‡³å°‘ 3 ä¸ªè§†å£æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚**

| è§†å£æ•°é‡ | åå­—çº¿æŒ‰é’®çŠ¶æ€ | è¯´æ˜ |
|---------|---------------|------|
| 1 ä¸ªè§†å£ | âŒ ç¦ç”¨ | å•è§†å£æ¨¡å¼ä¸æ”¯æŒåå­—çº¿ |
| 2 ä¸ªè§†å£ | âŒ ç¦ç”¨ | è§†å£æ•°é‡ä¸è¶³ |
| 3 ä¸ªè§†å£ | âœ… å¯ç”¨ | æ ‡å‡†ä¸‰å¹³é¢è§†å›¾ï¼ˆè½´ä½ã€çŸ¢çŠ¶ä½ã€å† çŠ¶ä½ï¼‰ |
| 4+ ä¸ªè§†å£ | âœ… å¯ç”¨ | æ”¯æŒæ›´å¤šè§†å£çš„é«˜çº§å¸ƒå±€ |

### 2. æ”¯æŒçš„å¸ƒå±€

#### âœ… æ”¯æŒåå­—çº¿çš„å¸ƒå±€

- **grid-1x3** (1Ã—3 æ¨ªå‘) - æ ‡å‡†ä¸‰å¹³é¢è§†å›¾
- **grid-3x1** (3Ã—1 çºµå‘) - çºµå‘ä¸‰å¹³é¢è§†å›¾
- **grid-2x2** (2Ã—2 å››è§†å›¾) - å››è§†å›¾å¸ƒå±€
- **grid-3x2** (3Ã—2 å…­è§†å›¾) - å…­è§†å›¾å¸ƒå±€
- **grid-2x3** (2Ã—3 å…­è§†å›¾) - å…­è§†å›¾å¸ƒå±€
- **grid-3x3** (3Ã—3 ä¹è§†å›¾) - ä¹è§†å›¾å¸ƒå±€
- æ‰€æœ‰åè®®å¸ƒå±€ï¼ˆMPRã€3D-four-up ç­‰ï¼‰

#### âŒ ä¸æ”¯æŒåå­—çº¿çš„å¸ƒå±€

- **grid-1x1** (1Ã—1 å•è§†å›¾) - å•è§†å£æ¨¡å¼
- **grid-1x2** (1Ã—2 æ¨ªå‘) - ä»… 2 ä¸ªè§†å£
- **grid-2x1** (2Ã—1 çºµå‘) - ä»… 2 ä¸ªè§†å£

---

## è‡ªåŠ¨ç¦ç”¨é€»è¾‘

### è§¦å‘æ¡ä»¶

å½“ç”¨æˆ·åˆ‡æ¢åˆ°è§†å£æ•°é‡å°‘äº 3 ä¸ªçš„å¸ƒå±€æ—¶ï¼Œå¦‚æœåå­—çº¿å·¥å…·å½“å‰å¤„äºæ¿€æ´»çŠ¶æ€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

#### 1. æ¿€æ´»çª—å®½çª—ä½å·¥å…·

```typescript
// 1. å…ˆæ¿€æ´»çª—å®½çª—ä½å·¥å…·ï¼ˆç¡®ä¿ç”¨æˆ·å§‹ç»ˆæœ‰ä¸€ä¸ªå¯ç”¨çš„äº¤äº’å·¥å…·ï¼‰
toolGroup.setToolActive(WindowLevelTool.toolName, {
  bindings: [{ mouseButton: MouseBindings.Primary }],
});
setIsWindowLevelActive(true);
```

**åŸå› **: çª—å®½çª—ä½å·¥å…·æ˜¯æœ€åŸºæœ¬å’Œæœ€å¸¸ç”¨çš„å›¾åƒè°ƒæ•´å·¥å…·ï¼Œç¦ç”¨åå­—çº¿ååº”è¯¥é»˜è®¤æ¿€æ´»å®ƒã€‚

#### 2. å°†æµ‹é‡å·¥å…·è®¾ä¸º Passive

```typescript
// 2. å°†å½“å‰æµ‹é‡å·¥å…·è®¾ä¸º Passiveï¼ˆå¯è§ä½†ä¸å¯ç¼–è¾‘ï¼‰
if (activeTool && toolGroup.hasTool(activeTool)) {
  toolGroup.setToolPassive(activeTool);
}
```

**åŸå› **: é¿å…å·¥å…·å†²çªï¼Œç¡®ä¿çª—å®½çª—ä½å·¥å…·ç‹¬å é¼ æ ‡äº¤äº’ã€‚

#### 3. ç¦ç”¨åå­—çº¿å·¥å…·

```typescript
// 3. ç¦ç”¨åå­—çº¿å·¥å…·
toolGroup.setToolDisabled(CrosshairsTool.toolName);
setShowCrosshairs(false);
```

### æ§åˆ¶å°æ—¥å¿—

æ‰§è¡Œè‡ªåŠ¨ç¦ç”¨æ—¶ä¼šè¾“å‡ºä»¥ä¸‹æ—¥å¿—ï¼š

```
âš ï¸ å¸ƒå±€åˆ‡æ¢åˆ°å°‘äº3ä¸ªè§†å£æ¨¡å¼ï¼Œå…ˆæ¿€æ´»çª—å®½çª—ä½ï¼Œå†ç¦ç”¨åå­—çº¿å·¥å…·
âœ… å·²æ¿€æ´»çª—å®½çª—ä½å·¥å…·
âœ… å·²ç¦ç”¨åå­—çº¿å·¥å…·
```

---

## æŠ€æœ¯å®ç°

### è§†å£æ•°é‡è®¡ç®—å‡½æ•°

```typescript
/**
 * æ ¹æ®å¸ƒå±€ç±»å‹è®¡ç®—è§†å£æ•°é‡
 * @param layout - å¸ƒå±€ç±»å‹ï¼ˆå¦‚ 'grid-1x3', 'grid-2x2'ï¼‰
 * @returns è§†å£æ•°é‡
 */
const getViewportCountFromLayout = (layout: ViewportLayout): number => {
  const match = layout.match(/grid-(\d+)x(\d+)/);
  if (match) {
    const rows = parseInt(match[1]);
    const cols = parseInt(match[2]);
    return rows * cols;
  }
  // å¯¹äºåè®®å¸ƒå±€ï¼Œè¿”å›é»˜è®¤å€¼
  return 3; // é»˜è®¤ MPR ä¸‰è§†å›¾
};
```

### Toolbar æŒ‰é’®ç¦ç”¨æ¡ä»¶

```typescript
<IconButton
  icon="ğŸ¯"
  onClick={onToggleCrosshairs}
  tooltip={showCrosshairs ? 'éšè—åå­—çº¿' : 'æ˜¾ç¤ºåå­—çº¿'}
  active={showCrosshairs}
  disabled={!hasVolume || viewportCount < 3}  // å…³é”®ï¼šviewportCount < 3
/>
```

**ç¦ç”¨æ¡ä»¶**:
1. `!hasVolume` - æ²¡æœ‰åŠ è½½ä½“ç§¯æ•°æ®
2. `viewportCount < 3` - è§†å£æ•°é‡å°‘äº 3 ä¸ª

### ä¼ é€’æ­£ç¡®çš„è§†å£æ•°é‡

```typescript
<Toolbar
  // ... å…¶ä»– props
  viewportCount={getViewportCountFromLayout(currentLayout)}  // ä½¿ç”¨å®é™…è§†å£æ•°é‡
/>
```

**é‡è¦**: å¿…é¡»ä½¿ç”¨ `getViewportCountFromLayout(currentLayout)` è®¡ç®—å®é™…æ˜¾ç¤ºçš„è§†å£æ•°é‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `viewportIds.length`ï¼ˆåè€…å§‹ç»ˆä¸º 3ï¼‰ã€‚

---

## å¸ƒå±€åˆ‡æ¢æ—¶çš„è¡Œä¸º

### åœºæ™¯ 1: ä»æ”¯æŒåå­—çº¿çš„å¸ƒå±€åˆ‡æ¢åˆ°ä¸æ”¯æŒçš„å¸ƒå±€

**ç¤ºä¾‹**: ä» `grid-1x3` åˆ‡æ¢åˆ° `grid-1x2`

1. ç”¨æˆ·ç‚¹å‡»å¸ƒå±€é¢æ¿ä¸­çš„ `1Ã—2 æ¨ªå‘`
2. ç³»ç»Ÿæ£€æµ‹åˆ°æ–°å¸ƒå±€çš„è§†å£æ•°é‡ä¸º 2ï¼ˆ< 3ï¼‰
3. å¦‚æœåå­—çº¿å½“å‰æ¿€æ´»ï¼Œæ‰§è¡Œè‡ªåŠ¨ç¦ç”¨é€»è¾‘
4. åå­—çº¿æŒ‰é’®å˜ä¸ºç¦ç”¨çŠ¶æ€ï¼ˆç°è‰²ï¼Œä¸å¯ç‚¹å‡»ï¼‰
5. çª—å®½çª—ä½æŒ‰é’®å˜ä¸ºæ¿€æ´»çŠ¶æ€ï¼ˆç»¿è‰²ï¼‰

### åœºæ™¯ 2: ä»ä¸æ”¯æŒçš„å¸ƒå±€åˆ‡æ¢åˆ°æ”¯æŒçš„å¸ƒå±€

**ç¤ºä¾‹**: ä» `grid-1x2` åˆ‡æ¢åˆ° `grid-1x3`

1. ç”¨æˆ·ç‚¹å‡»å¸ƒå±€é¢æ¿ä¸­çš„ `1Ã—3 æ¨ªå‘`
2. ç³»ç»Ÿæ£€æµ‹åˆ°æ–°å¸ƒå±€çš„è§†å£æ•°é‡ä¸º 3ï¼ˆâ‰¥ 3ï¼‰
3. åå­—çº¿æŒ‰é’®å˜ä¸ºå¯ç”¨çŠ¶æ€ï¼ˆå¯ç‚¹å‡»ï¼‰
4. ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®æ¿€æ´»åå­—çº¿

---

## ç”¨æˆ·äº¤äº’è§„èŒƒ

### æ¿€æ´»åå­—çº¿

1. **ç¡®ä¿è§†å£æ•°é‡**: åˆ‡æ¢åˆ° 3 ä¸ªæˆ–æ›´å¤šè§†å£çš„å¸ƒå±€
2. **åŠ è½½ä½“ç§¯æ•°æ®**: ç¡®ä¿å·²åŠ è½½ DICOM ä½“ç§¯æ•°æ®
3. **ç‚¹å‡»æŒ‰é’®**: ç‚¹å‡»å·¥å…·æ çš„ ğŸ¯ æŒ‰é’®
4. **éªŒè¯çŠ¶æ€**: æŒ‰é’®å˜ä¸ºæ¿€æ´»çŠ¶æ€ï¼ˆç»¿è‰²ï¼‰ï¼Œè§†å£ä¸­æ˜¾ç¤ºåå­—çº¿

### ç¦ç”¨åå­—çº¿

æœ‰ä¸¤ç§æ–¹å¼ç¦ç”¨åå­—çº¿ï¼š

#### æ–¹å¼ 1: æ‰‹åŠ¨ç¦ç”¨
1. ç‚¹å‡»å·¥å…·æ çš„ ğŸ¯ æŒ‰é’®
2. åå­—çº¿å·¥å…·è¢«ç¦ç”¨
3. çª—å®½çª—ä½å·¥å…·è‡ªåŠ¨æ¿€æ´»

#### æ–¹å¼ 2: è‡ªåŠ¨ç¦ç”¨ï¼ˆå¸ƒå±€åˆ‡æ¢ï¼‰
1. åˆ‡æ¢åˆ°å°‘äº 3 ä¸ªè§†å£çš„å¸ƒå±€
2. ç³»ç»Ÿè‡ªåŠ¨ç¦ç”¨åå­—çº¿
3. çª—å®½çª—ä½å·¥å…·è‡ªåŠ¨æ¿€æ´»
4. åå­—çº¿æŒ‰é’®å˜ä¸ºç¦ç”¨çŠ¶æ€

---

## é”™è¯¯å¤„ç†

### å°è¯•åœ¨ä¸æ”¯æŒçš„å¸ƒå±€ä¸­æ¿€æ´»åå­—çº¿

å¦‚æœç”¨æˆ·å°è¯•åœ¨ä¸æ”¯æŒçš„å¸ƒå±€ä¸­æ¿€æ´»åå­—çº¿ï¼ˆä¾‹å¦‚é€šè¿‡ä»£ç ï¼‰ï¼Œç³»ç»Ÿä¼šè¾“å‡ºè­¦å‘Šï¼š

```typescript
if (!hasMultipleViewports) {
  console.warn('âš ï¸ å•è§†å£æ¨¡å¼ä¸‹ä¸æ”¯æŒåå­—çº¿å·¥å…·');
  return;
}
```

### æŒ‰é’®ç¦ç”¨ä½†ä»å¯ç‚¹å‡»çš„ Bug

**ç—‡çŠ¶**: å¸ƒå±€åˆ‡æ¢åˆ°å°‘äº 3 ä¸ªè§†å£åï¼Œåå­—çº¿æŒ‰é’®çœ‹èµ·æ¥ç¦ç”¨äº†ï¼Œä½†ä»å¯ç‚¹å‡»å¹¶å¯¼è‡´é”™è¯¯ã€‚

**åŸå› **: `viewportCount` å±æ€§ä¼ é€’äº†é”™è¯¯çš„å€¼ï¼ˆä½¿ç”¨ `viewportIds.length` è€Œä¸æ˜¯å®é™…å¸ƒå±€çš„è§†å£æ•°é‡ï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// âŒ é”™è¯¯
viewportCount={viewportIds.length}  // å§‹ç»ˆä¸º 3

// âœ… æ­£ç¡®
viewportCount={getViewportCountFromLayout(currentLayout)}  // æ ¹æ®å¸ƒå±€åŠ¨æ€è®¡ç®—
```

---

## æœ€ä½³å®è·µ

### 1. å¸ƒå±€é€‰æ‹©

- **è¯Šæ–­é˜…ç‰‡**: ä½¿ç”¨ `grid-1x3` æˆ– `grid-3x1` ä¸‰è§†å›¾å¸ƒå±€ï¼Œå¯ç”¨åå­—çº¿
- **ç²¾ç»†æ¯”è¾ƒ**: ä½¿ç”¨ `grid-2x2` å››è§†å›¾å¸ƒå±€ï¼Œå¯ç”¨åå­—çº¿
- **å•ä¸€èšç„¦**: ä½¿ç”¨ `grid-1x1` å•è§†å›¾å¸ƒå±€ï¼Œåå­—çº¿è‡ªåŠ¨ç¦ç”¨
- **åŒçª—å¯¹æ¯”**: ä½¿ç”¨ `grid-1x2` æˆ– `grid-2x1` åŒè§†å›¾å¸ƒå±€ï¼Œåå­—çº¿è‡ªåŠ¨ç¦ç”¨

### 2. å·¥å…·åˆ‡æ¢æµç¨‹

**æ¨èæµç¨‹**:
1. åŠ è½½æ•°æ® â†’ é»˜è®¤æ¿€æ´»çª—å®½çª—ä½å·¥å…·
2. è°ƒæ•´çª—å®½çª—ä½ â†’ è·å¾—æœ€ä½³å›¾åƒå¯¹æ¯”åº¦
3. åˆ‡æ¢åˆ°ä¸‰è§†å›¾å¸ƒå±€ â†’ åå­—çº¿æŒ‰é’®å˜ä¸ºå¯ç”¨
4. æ¿€æ´»åå­—çº¿ â†’ è¿›è¡Œå¤šå¹³é¢åŒæ­¥æµè§ˆ
5. éœ€è¦æµ‹é‡æ—¶ â†’ ç¦ç”¨åå­—çº¿ï¼Œæ¿€æ´»æµ‹é‡å·¥å…·
6. åˆ‡æ¢åˆ°å•è§†å›¾ â†’ åå­—çº¿è‡ªåŠ¨ç¦ç”¨ï¼Œçª—å®½çª—ä½è‡ªåŠ¨æ¿€æ´»

### 3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

- **æ¸…æ™°çš„çŠ¶æ€åé¦ˆ**: æŒ‰é’®çš„æ¿€æ´»/ç¦ç”¨çŠ¶æ€åº”è¯¥æ¸…æ™°å¯è§
- **åˆç†çš„é»˜è®¤å·¥å…·**: å¸ƒå±€åˆ‡æ¢æ—¶è‡ªåŠ¨æ¿€æ´»åˆé€‚çš„å·¥å…·
- **å¹³æ»‘çš„å·¥å…·è¿‡æ¸¡**: ç¦ç”¨åå­—çº¿å‰å…ˆæ¿€æ´»æ›¿ä»£å·¥å…·ï¼Œé¿å…å·¥å…·çœŸç©ºæœŸ

---

## ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒå®ç°æ–‡ä»¶

- **ä¸»ç»„ä»¶**: `src/MPRViewer.tsx`
  - `getViewportCountFromLayout()` - è§†å£æ•°é‡è®¡ç®—å‡½æ•°
  - `handleLayoutChange()` - å¸ƒå±€åˆ‡æ¢å¤„ç†é€»è¾‘
  - `handleToggleCrosshairs()` - åå­—çº¿åˆ‡æ¢å¤„ç†

- **å·¥å…·æ ç»„ä»¶**: `src/components/Toolbar.tsx`
  - åå­—çº¿æŒ‰é’®çš„ç¦ç”¨æ¡ä»¶
  - è§†å£æ•°é‡å±æ€§ä¼ é€’

### ç›¸å…³æ–‡æ¡£

- [VIEWPORT_DOUBLE_CLICK_FEATURE.md](VIEWPORT_DOUBLE_CLICK_FEATURE.md) - åŒå‡»æ”¾å¤§åŠŸèƒ½
- [LAYOUT_IMPLEMENTATION_SUMMARY.md](LAYOUT_IMPLEMENTATION_SUMMARY.md) - å¸ƒå±€å®ç°æ€»ç»“
- [TOOLGROUP_ARCHITECTURE_FIX.md](TOOLGROUP_ARCHITECTURE_FIX.md) - å·¥å…·ç»„æ¶æ„

---

## å¸¸è§é—®é¢˜ (FAQ)

### Q1: ä¸ºä»€ä¹ˆåå­—çº¿éœ€è¦è‡³å°‘ 3 ä¸ªè§†å£ï¼Ÿ

**A**: åå­—çº¿å·¥å…·çš„è®¾è®¡ç›®çš„æ˜¯åœ¨ä¸‰ä¸ªæ­£äº¤å¹³é¢ï¼ˆè½´ä½ã€çŸ¢çŠ¶ä½ã€å† çŠ¶ä½ï¼‰ä¹‹é—´åŒæ­¥æ˜¾ç¤ºä½ç½®ä¿¡æ¯ã€‚å°‘äº 3 ä¸ªè§†å£æ— æ³•æä¾›å®Œæ•´çš„ç©ºé—´å®šä½ä¿¡æ¯ã€‚

### Q2: å¯ä»¥åœ¨ 2 ä¸ªè§†å£ä¸­ä½¿ç”¨åå­—çº¿å—ï¼Ÿ

**A**: æŠ€æœ¯ä¸Šå¯ä»¥ï¼Œä½† Cornerstone3D çš„åå­—çº¿å·¥å…·å®ç°è‡³å°‘éœ€è¦ 3 ä¸ªè§†å£æ‰èƒ½æ­£å¸¸å·¥ä½œï¼Œå¦åˆ™ä¼šå‡ºç°æ¸²æŸ“é”™è¯¯æˆ–è¡Œä¸ºå¼‚å¸¸ã€‚

### Q3: åˆ‡æ¢å¸ƒå±€æ—¶ä¸ºä»€ä¹ˆè¦å…ˆæ¿€æ´»çª—å®½çª—ä½ï¼Ÿ

**A**: ç¡®ä¿ç”¨æˆ·å§‹ç»ˆæœ‰ä¸€ä¸ªå¯ç”¨çš„äº¤äº’å·¥å…·ã€‚å¦‚æœåªæ˜¯ç¦ç”¨åå­—çº¿è€Œä¸æ¿€æ´»æ›¿ä»£å·¥å…·ï¼Œç”¨æˆ·ä¼šå¤„äº"æ— å·¥å…·å¯ç”¨"çš„çŠ¶æ€ï¼Œå½±å“ä½“éªŒã€‚

### Q4: åå­—çº¿å’Œæµ‹é‡å·¥å…·å¯ä»¥åŒæ—¶ä½¿ç”¨å—ï¼Ÿ

**A**: ä¸å¯ä»¥ã€‚åå­—çº¿æ¿€æ´»æ—¶ï¼Œæµ‹é‡å·¥å…·ä¼šè¢«è®¾ä¸º Passive æ¨¡å¼ï¼ˆå¯è§ä½†ä¸å¯ç¼–è¾‘ï¼‰ã€‚åä¹‹äº¦ç„¶ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…å·¥å…·å†²çªã€‚

### Q5: å¦‚ä½•è‡ªå®šä¹‰åå­—çº¿çš„æœ€å°è§†å£æ•°é‡è¦æ±‚ï¼Ÿ

**A**: ä¿®æ”¹ä»¥ä¸‹ä¸¤å¤„ä»£ç ï¼š
1. `Toolbar.tsx` ä¸­çš„ `disabled` æ¡ä»¶
2. `MPRViewer.tsx` ä¸­çš„ `handleLayoutChange` æ¡ä»¶

å°† `viewportCount < 3` æ”¹ä¸ºæ‰€éœ€çš„æ•°é‡ï¼ˆå¦‚ `viewportCount < 2`ï¼‰ã€‚

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´è¯´æ˜ |
|------|------|---------|
| 1.0 | 2025-01-24 | åˆå§‹ç‰ˆæœ¬ï¼Œå®šä¹‰åå­—çº¿å·¥å…·çš„ä½¿ç”¨é™åˆ¶å’Œè‡ªåŠ¨ç¦ç”¨é€»è¾‘ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-01-24
**ç»´æŠ¤è€…**: Claude Code
